# DO NOT EDIT THIS FILE!
# Please make all changes to files in $SPLUNK_HOME/etc/apps/TA_opnsense/local.
# To make changes, copy the section/stanza you want to change from $SPLUNK_HOME/etc/apps/TA_opnsense/default
# into ../local and edit there.

#===========================================
# Sourcetypes
#===========================================
[opnsense_sourcetype_filterlog]
DEST_KEY = MetaData:Sourcetype
REGEX    = filterlog\:
FORMAT   = sourcetype::opnsense:filterlog

[opnsense_sourcetype_dhcpd]
DEST_KEY = MetaData:Sourcetype
REGEX    = dhcpd\:
FORMAT   = sourcetype::opnsense:dhcpd

[opnsense_sourcetype_squid]
DEST_KEY = MetaData:Sourcetype
REGEX    = squid\S*:\s
FORMAT   = sourcetype::opnsense:squid

[opnsense_sourcetype_suricata]
DEST_KEY = MetaData:Sourcetype
REGEX    = suricata\S+\:\s
FORMAT   = sourcetype::opnsense:suricata

[opnsense_sourcetype_cron]
DEST_KEY = MetaData:Sourcetype
REGEX    = cron\[\d+\]
FORMAT   = sourcetype::opnsense:cron

[opnsense_sourcetype_unbound]
DEST_KEY = MetaData:Sourcetype
REGEX    = unbound\:
FORMAT   = sourcetype::opnsense:unbound

[opnsense_sourcetype_lighttpd]
DEST_KEY = MetaData:Sourcetype
REGEX    = lighttpd\[\d+\]
FORMAT   = sourcetype::opnsense:lighttpd

[opnsense_sourcetype_access]
DEST_KEY = MetaData:Sourcetype
REGEX    = opnsense\:
FORMAT   = sourcetype::opnsense:access

[opnsense_sourcetype_openvpn]
DEST_KEY = MetaData:Sourcetype
REGEX    = openvpn\[*\:*
FORMAT   = sourcetype::opnsense:openvpn

#===========================================
# Search Time Field Extractions:  GLOBAL
#===========================================
[opnsense_dvc_ip]
REGEX  = \s(\d{1,3}(?:\.\d{1,3}){3})\s
FORMAT = dvc_ip::$1

#===========================================
# Search Time Field Extractions:  FILTERLOG
#===========================================
[opnsense_filterlog_main]
REGEX  = filterlog:\s+([^\,a-z]*)\,([^\,]*)\,([^\,]*)\,([^\,]*)\,([^\,]*)\,([^\,]*)\,([^\,]*)\,([^\,]*)\,
FORMAT = rule_id::$1 sub_rule_id::$2 anchor_name::$3 tracker_id::$4 dest_int::$5 reason::$6 vendor_action::$7 vendor_direction::$8

[opnsense_filterlog_repeat_msg]
REGEX  = filterlog:\s+message\s+repeated\s+(\S+)\s+times\:\s+\[\s+([^\,]*)\,([^\,]*)\,([^\,]*)\,([^\,]*)\,([^\,]*)\,([^\,]*)\,([^\,]*)\,([^\,]*)\,
FORMAT = repeat_msg_count::$1 rule_id::$2 sub_rule_id::$3 anchor_name::$4 tracker_id::$5 dest_int::$6 reason::$7 vendor_action::$8 vendor_direction::$9

[opnsense_icmp_4]
REGEX  = filterlog\:\s+(?:[^\,]*\,){8}(4)\,([^\,]*)\,([^\,]*)\,([^\,]*)\,([^\,]*)\,([^\,]*)\,([^\,]*)\,([^\,]*)\,(icmp)\,([^\,]*)\,([^\,]*)\,([^\,]*)\,
FORMAT = ip_version::$1 tos::$2 ecn::$3 ttl::$4 id::$5 offset::$6 flags::$7 transport_id::$8 vendor_transport::$9 bytes::$10 src_ip::$11 dest_ip::$12

[opnsense_icmp_6]
REGEX  = filterlog\:\s+(?:[^\,]*\,){8}(6)\,([^\,]*)\,([^\,]*)\,([^\,]*)\,(ICMPv6|ipv6-icmp)\,([^\,]*)\,([^\,]*)\,([^\,]*)\,([^\,]*)\,
FORMAT = ip_version::$1 class::$2 flow_label::$3 hop_limit::$4 vendor_transport::$5 transport_id::$6 bytes::$7 src_ip::$8 dest_ip::$9

[opnsense_tcp_4]
REGEX  = filterlog\:\s+(?:[^\,]*\,){8}(4)\,([^\,]*)\,([^\,]*)\,([^\,]*)\,([^\,]*)\,([^\,]*)\,([^\,]*)\,([^\,]*)\,(tcp)\,([^\,]*)\,([^\,]*)\,([^\,]*)\,([^\,]*)\,([^\,]*)\,([^\,]*)\,([^\,]*)\,([^\,]*)\,([^\,]*)\,([^\,]*)\,([^\,]*)\,(\S*)
FORMAT = ip_version::$1 tos::$2 ecn::$3 ttl::$4 id::$5 offset::$6 flags::$7 transport_id::$8 vendor_transport::$9 bytes::$10 src_ip::$11 dest_ip::$12 src_port::$13 dest_port::$14 payload_bytes::$15 vendor_tcp_flags::$16 sequence_number::$17 ack::$18 window::$19 urg::$20 vendor_options::$21

[opnsense_tcp_6]
REGEX  = filterlog\:\s+(?:[^\,]*\,){8}(6)\,([^\,]*)\,([^\,]*)\,([^\,]*)\,([Tt][Cc][Pp])\,([^\,]*)\,([^\,]*)\,([^\,]*)\,([^\,]*)\,([^\,]*)\,([^\,]*)\,([^\,]*)\,([^\,]*)\,([^\,]*)\,([^\,]*)\,([^\,]*)\,([^\,]*)\,(\S*)
FORMAT = ip_version::$1 class::$2 flow_label::$3 hop_limit::$4 vendor_transport::$5 transport_id::$6 bytes::$7 src_ip::$8 dest_ip::$9 src_port::$10 dest_port::$11 payload_bytes::$12 vendor_tcp_flags::$13 sequence_number::$14 ack::$15 window::$16 urg::$17 options::$18

[opnsense_udp_4]
REGEX  = filterlog\:\s+(?:[^\,]*\,){8}(4)\,([^\,]*)\,([^\,]*)\,([^\,]*)\,([^\,]*)\,([^\,]*)\,([^\,]*)\,([^\,]*)\,(udp)\,([^\,]*)\,([^\,]*)\,([^\,]*)\,([^\,]*)\,([^\,]*)\,(\S*)
FORMAT = ip_version::$1 tos::$2 ecn::$3 ttl::$4 id::$5 offset::$6 flags::$7 transport_id::$8 vendor_transport::$9 bytes::$10 src_ip::$11 dest_ip::$12 src_port::$13 dest_port::$14 payload_bytes::$15

[opnsense_udp_6]
REGEX  = filterlog\:\s+(?:[^\,]*\,){8}(6)\,([^\,]*)\,([^\,]*)\,([^\,]*)\,([Uu][Dd][Pp])\,([^\,]*)\,([^\,]*)\,([^\,]*)\,([^\,]*)\,([^\,]*)\,([^\,]*)\,(\S*)
FORMAT = ip_version::$1 class::$2 flow_label::$3 hop_limit::$4 vendor_transport::$5 transport_id::$6 bytes::$7 src_ip::$8 dest_ip::$9 src_port::$10 dest_port::$11 payload_bytes::$12

#===========================================
# Search Time Field Extractions:  DHCP
#===========================================
[opnsense_dhcp_main]
REGEX  = dhcpd:\s+(\S+)\s\S+\s(\S+)\s(?:\([^\)]+\)\s)*\S+\s(\S+)\s(?:\(([^\)]+)\)\s)*via\s(\S+)
FORMAT = vendor_event::$1 client_ip::$2 client_mac::$3 client_name::$4 interface::$5

[opnsense_dhcp_discover]
REGEX  = dhcpd:\s(DHCPDISCOVER)\sfrom\s(\S+)\s(?:\((\S+)\)\s)*via\s(\S+)
FORMAT = vendor_event::$1 client_mac::$2 client_name::$3 interface::$4

[opnsense_dhcp_reuse_lease]
REGEX  = dhcpd:\s(reuse_lease)\:\slease\sage\s(\S+)
FORMAT = vendor_event::$1 lease_age_seconds::$2

#===========================================
# Search Time Field Extractions:  SURICATA
#===========================================
[opnsense_suricata_category]
REGEX  = Classification\:\s+([^\]]+)
FORMAT = category::"$1"

[opnsense_suricata_dest_ip]
REGEX  = \-\>\s+([^\:]+)
FORMAT = dest_ip::$1

[opnsense_suricata_dest_port]
REGEX  = \-\>\s+[^\:]+\:(\S+)
FORMAT = dest_port::$1

[opnsense_suricata_pid]
REGEX  = suricata\[([^\]]+)
FORMAT = pid::$1

[opnsense_suricata_severity_id]
REGEX  = Priority\:\s+([^\]]+)
FORMAT = severity_id::$1

[opnsense_suricata_signature]
REGEX  = suricata\[[^\]]+\]\:\s+\[[^\]]+\]\s+([^\]]+)\s+\[
FORMAT = signature::"$1"

[opnsense_suricata_signature_id]
REGEX  = suricata\[[^\]]+\]\:\s+\[([^\]]+)
FORMAT = signature_id::"$1"

[opnsense_suricata_src_ip]
REGEX  = \{[^\}]+\}\s+([^\:]+)
FORMAT = src_ip::$1

[opnsense_suricata_src_port]
REGEX  = \{[^\:]+\:(\S+)
FORMAT = src_port::$1

[opnsense_suricata_transport]
REGEX  = \{([^\}]+)
FORMAT = vendor_transport::$1

#===========================================
# Search Time Field Extractions:  SQUID
#===========================================
[1_opnsense_squid_main]
REGEX  = \:\s+\S+\s+(\d+)\s+(\S+)\s+([^\/]+)\/(\S+)\s+(\S+)\s+(\S+)\s+(\S+)\s+(\S+)\s+([^\/]+)\/(\S+)\s+(\S+)
FORMAT = duration::$1 src_ip::$2 vendor_action::$3 status::$4 bytes_in::$5 bytes_out::0 http_method::$6 url::$7 user::$8 dest_status::$9 dest_ip::$10 http_content_type::$11

[2_opnsense_squid_url]
SOURCE_KEY = url
REGEX = (\d{1,3}(?:\.\d{1,3}){3})
FORMAT = dest_ip_url::$1

#===========================================
# Search Time Field Extractions:  CRON
#===========================================
[opnsense_cron_main]
REGEX  = \((\w+)\) CMD \(\(?(.+?)\)?(?: > (.+?))?\)
FORMAT = user::$1 command::$2 output::$3

#===========================================
# Search Time Field Extractions:  UNBOUND
#===========================================
[opnsense_unbound_query]
REGEX = info:\s+(\S+)\s+(\S+)\s+(\S+)\s+IN
FORMAT = src::$1 query::$2 record_type::$3

#===========================================
# Search Time Field Extractions:  LIGHTTPD
#===========================================
[opnsense_lighttpd_extract]
REGEX  = lighttpd\[\d+\]\:\s+(\S+)\s+(\S+)\s+\-\s+\[([^\]]+)\]\s+\"(\S+)\s+(.+?)(\?\S+)*\s+([^\"]+)\"\s+(\d+)\s+(\d+)\s+\"([^\"]+)\"\s+\"([^\"]+)
FORMAT = src_ip::$1 dest_ip::$2 vendor_timestamp::$3 http_method::$4 uri_path::$5 uri_query::$6 protocol_version::$7 status::$8 tbd::$9 url::$10 http_user_agent::$11

#===========================================
# Search Time Field Extractions:  ACCESS
#===========================================
[opnsense_access_extract]
REGEX  = opnsense\:\s+(\S+)\:\s+(.+?)\sfor\s+(?:user\s+)*\'([^\']+)\'\s+from\:*\s+(\S+)
FORMAT = uri::$1 signature::$2 user::$3 src_ip::$4

#===========================================
# Search Time Field Extractions:  OPENVPN
#===========================================
[opnsense_openvpn_extract]
REGEX = user\s+\'(?<user>[^\']+)'\s+\S+\s+\S+\s+\'(?<auth_method>[^\']+)

#===========================================
# Advanced Search Time Configs
#===========================================
[opnsense_vendor_tcp_flag]
SOURCE_KEY = vendor_tcp_flags
REGEX      = (\w)
FORMAT     = vendor_tcp_flag::$1
MV_ADD     = true

#===========================================
# Lookups:  FILTERLOG
#===========================================
[opnsense_filterlog_action_lookup]
filename      = opnsense_filterlog_action.csv
min_matches   = 1
default_match = unknown

[opnsense_filterlog_direction_lookup]
filename      = opnsense_filterlog_direction.csv
min_matches   = 1
default_match = unknown

[opnsense_filterlog_tcp_flags_lookup]
filename      = opnsense_filterlog_tcp_flags.csv
min_matches   = 1
default_match = unknown

[opnsense_transport_lookup]
filename             = opnsense_transport.csv
max_matches          = 1
min_matches          = 1
default_match        = unknown
case_sensitive_match = false

[opnsense_tos_lookup]
filename             = opnsense_filterlog_tos.csv
min_matches          = 1
default_match        = unknown
case_sensitive_match = false

#===========================================
# Lookups:  SURICATA
#===========================================
[opnsense_suricata_severity_lookup]
filename      = opnsense_suricata_severities.csv
min_matches   = 1
default_match = unknown

#===========================================
# Lookups:  SQUID
#===========================================
[opnsense_squid_action_lookup]
filename      = opnsense_squid_actions.csv
max_matches   = 1
min_matches   = 1
default_match = unknown

[opnsense_squid_status_lookup]
filename = opnsense_squid_status.csv
