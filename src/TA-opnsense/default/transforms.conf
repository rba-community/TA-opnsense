# DO NOT EDIT THIS FILE!
# Please make all changes to files in $SPLUNK_HOME/etc/apps/TA_opnsense/local.
# To make changes, copy the section/stanza you want to change from $SPLUNK_HOME/etc/apps/TA_opnsense/default
# into ../local and edit there.
#
#===========================================
# Add raw length to Meta Fields
#===========================================
[opnsense_raw_length]
INGEST_EVAL = opnsense_event_length=len(_raw)

#===========================================
# Convert output to JSON when using eve
#===========================================
[opnsense_make_suricata_json]
DEST_KEY = _raw
REGEX    = suricata\S+:\s([{].+)
FORMAT   = $1

#===========================================
# Sourcetypes
#===========================================
[opnsense_sourcetype_access]
DEST_KEY = MetaData:Sourcetype
REGEX    = webgui\[
FORMAT   = sourcetype::opnsense:access

[opnsense_sourcetype_audit]
DEST_KEY = MetaData:Sourcetype
REGEX    = audit\[
FORMAT   = sourcetype::opnsense:audit

[opnsense_sourcetype_cron]
DEST_KEY = MetaData:Sourcetype
REGEX    = cron\[\d+\]
FORMAT   = sourcetype::opnsense:cron

[opnsense_sourcetype_dhcpd]
DEST_KEY = MetaData:Sourcetype
REGEX    = dhcpd(?:\[[^\]]+\]):*
FORMAT   = sourcetype::opnsense:dhcpd

[opnsense_sourcetype_filterlog]
DEST_KEY = MetaData:Sourcetype
REGEX    = filterlog(?:\[[^\]]+\]):*
FORMAT   = sourcetype::opnsense:filterlog

[opnsense_sourcetype_lighttpd]
DEST_KEY = MetaData:Sourcetype
REGEX    = lighttpd\[\d+\]
FORMAT   = sourcetype::opnsense:lighttpd

[opnsense_sourcetype_openvpn]
DEST_KEY = MetaData:Sourcetype
REGEX    = openvpn\w*(?:\[[^\]]+\]):*
FORMAT   = sourcetype::opnsense:openvpn

[opnsense_sourcetype_squid]
DEST_KEY = MetaData:Sourcetype
REGEX    = squid\S*:\s
FORMAT   = sourcetype::opnsense:squid

[opnsense_sourcetype_suricata]
DEST_KEY = MetaData:Sourcetype
REGEX    = suricata\S+\:\s[^{]
FORMAT   = sourcetype::opnsense:suricata

[opnsense_sourcetype_suricata_json]
DEST_KEY = MetaData:Sourcetype
REGEX    = suricata\S+\:\s[{]
FORMAT   = sourcetype::opnsense:suricata:json

[opnsense_sourcetype_suricata_json_alt]
INGEST_EVAL = sourcetype=if(json_valid(_raw) AND match(_raw, "^\{\"timestamp\":"), "opnsense:suricata:json", sourcetype)

[opnsense_sourcetype_syslog]
DEST_KEY = MetaData:Sourcetype
REGEX    = syslog-ng\[
FORMAT   = sourcetype::opnsense:syslog

[opnsense_sourcetype_unbound]
DEST_KEY = MetaData:Sourcetype
REGEX    = unbound(?:\[[^\]]+\]):*
FORMAT   = sourcetype::opnsense:unbound

#===========================================
# Search Time Field Extractions:  GLOBAL
#===========================================
[opnsense_dvc_ip]
REGEX  = \s(\d{1,3}(?:\.\d{1,3}){3})\s
FORMAT = dvc_ip::$1

#===========================================
# Search Time Field Extractions:  ACCESS
#===========================================
[opnsense_access_extract]
REGEX  = webgui(?:\[(?<pid>[^\]]+)\]):*\s+(?<uri>\S+)\:\s+(?<signature>.+?)\sfor\s+(?:user\s+)*\'(?<user>[^\']+)\'\s+from\:*\s+(?<src_ip>\S+)

#===========================================
# Search Time Field Extractions:  AUDIT
#===========================================
#--- Modular Regex ---#
# Extracts: pid
[opnsense_audit_global]
REGEX  = audit(?:\[([^\]]+)\]):\s
FORMAT = pid::$1
#--- End Modular Regex ---#

[opnsense_audit_extract]
REGEX = [[opnsense_audit_global]](?<uri>\S+)\:\s+(?<signature>.+?)\sfor\s+(?:user\s+)*\'(?<user>[^\']+)\'\s+from\:*\s+(?<src_ip>\S+)

[opnsense_audit_local_login_extract]
REGEX = [[opnsense_audit_global]]user (?<user>\S+) (?<signature>.+?) for login

[opnsense_audit_change_extract]
REGEX = user (?<user>[^@]+)@(?<src_ip>\S+) (?<signature>changed configuration)

#===========================================
# Search Time Field Extractions:  CRON
#===========================================
[opnsense_cron_main]
REGEX  = \((\w+)\) CMD \(\(?(.+?)\)?(?: > (.+?))?\)
FORMAT = user::$1 command::$2 output::$3

#===========================================
# Search Time Field Extractions:  DHCP
#===========================================
#--- Modular Regex ---#
[opnsense_dhcp_mod]
# Extracts: pid
REGEX = dhcpd(?:\[(?<pid>[^\]]+)\])*:
#--- End Modular Regex ---#

[opnsense_dhcp_main]
REGEX  = [[opnsense_dhcp_mod]]\s+(?<vendor_event>\S+)\s\S+\s(?<client_ip>\S+)\s(?:\([^\)]+\)\s)*\S+\s(?<client_mac>\S+)\s(?:\((?<client_name>[^\)]+)\)\s)*via\s(?<interface>\S+)

[opnsense_dhcp_discover]
REGEX  = [[opnsense_dhcp_mod]]\s(?<vendor_event>DHCPDISCOVER)\sfrom\s(?<client_mac>\S+)\s(?:\((?<client_name>\S+)\)\s)*via\s(?<interface>\S+)

[opnsense_dhcp_reuse_lease]
REGEX  = [[opnsense_dhcp_mod]]\s(?<vendor_event>reuse_lease)\:\slease\sage\s(?<lease_age_seconds>\S+)

#===========================================
# Search Time Field Extractions:  FILTERLOG
#===========================================
#--- Modular Regex ---#
[opnsense_filterlog_mod_main]
# Extracts: pid, rule_id, sub_rule_id, anchor_name, tracker_id, dest_interface,
#           reason, vendor_action, vendor_direction
REGEX  = filterlog(?:\[(?<pid>[^\]]+)\])*:\s+(?<rule_id>[^\,a-z]*)\,(?<sub_rule_id>[^\,]*)\,(?<anchor_name>[^\,]*)\,(?<tracker_id>[^\,]*)\,(?<dest_interface>[^\,]*)\,(?<reason>[^\,]*)\,(?<vendor_action>[^\,]*)\,(?<vendor_direction>[^\,]*)\,

[opnsense_filterlog_mod_ipv4]
# Extracts: ip_version, tos, ecn, ttl, id, offset, flags, transport_id
REGEX = [[opnsense_filterlog_mod_main]](?<ip_version>4)\,(?<tos>[^\,]*)\,(?<ecn>[^\,]*)\,(?<ttl>[^\,]*)\,(?<id>[^\,]*)\,(?<offset>[^\,]*)\,(?<flags>[^\,]*)\,(?<transport_id>[^\,]*)\,

[opnsense_filterlog_mod_ipv6]
# Extracts: ip_version, class, flow_label, hop_limit
REGEX = [[opnsense_filterlog_mod_main]](?<ip_version>6)\,(?<class>[^\,]*)\,(?<flow_label>[^\,]*)\,(?<hop_limit>[^\,]*)\,
#--- End Modular Regex ---#

[opnsense_filterlog_repeat_msg]
REGEX  = filterlog(?:\[(?<pid>[^\]]+)\])*:\s+message\s+repeated\s+(?<repeat_msg_count>\S+)\s+times\:\s+\[\s+(?<rule_id>[^\,]*)\,(?<sub_rule_id>[^\,]*)\,(?<anchor_name>[^\,]*)\,(?<tracker_id>[^\,]*)\,(?<dest_int>[^\,]*)\,(?<reason>[^\,]*)\,(?<vendor_action>[^\,]*)\,(?<vendor_direction>[^\,]*)\,

[opnsense_icmp_4]
REGEX  = [[opnsense_filterlog_mod_ipv4]](?<vendor_transport>icmp|igmp)\,(?<bytes>[^\,]*)\,(?<src_ip>[^\,]*)\,(?<dest_ip>[^\,]*)\,

[opnsense_icmp_6]
REGEX  = [[opnsense_filterlog_mod_ipv6]](?<vendor_transport>ICMPv6|ipv6-icmp)\,(?<transport_id>[^\,]*)\,(?<bytes>[^\,]*)\,(?<src_ip>[^\,]*)\,(?<dest_ip>[^\,]*)\,

[opnsense_tcp_4]
REGEX  = [[opnsense_filterlog_mod_ipv4]](?<vendor_transport>tcp)\,(?<bytes>[^\,]*)\,(?<src_ip>[^\,]*)\,(?<dest_ip>[^\,]*)\,(?<src_port>[^\,]*)\,(?<dest_port>[^\,]*)\,(?<payload_bytes>[^\,]*)\,(?<vendor_tcp_flags>[^\,]*)\,(?<sequence_number>[^\,]*)\,(?<ack>[^\,]*)\,(?<window>[^\,]*)\,(?<urg>[^\,]*)\,(?<vendor_options>\S*)

[opnsense_tcp_6]
REGEX  = [[opnsense_filterlog_mod_ipv6]](?<vendor_transport>[Tt][Cc][Pp])\,(?<transport_id>[^\,]*)\,(?<bytes>[^\,]*)\,(?<src_ip>[^\,]*)\,(?<dest_ip>[^\,]*)\,(?<src_port>[^\,]*)\,(?<dest_port>[^\,]*)\,(?<payload_bytes>[^\,]*)\,(?<vendor_tcp_flags>[^\,]*)\,(?<sequence_number>[^\,]*)\,(?<ack>[^\,]*)\,(?<window>[^\,]*)\,(?<urg>[^\,]*)\,(?<vendor_options>\S*)

[opnsense_udp_4]
REGEX  = [[opnsense_filterlog_mod_ipv4]](?<vendor_transport>udp)\,(?<bytes>[^\,]*)\,(?<src_ip>[^\,]*)\,(?<dest_ip>[^\,]*)\,(?<src_port>[^\,]*)\,(?<dest_port>[^\,]*)\,(?<payload_bytes>\S*)

[opnsense_udp_6]
REGEX  =  [[opnsense_filterlog_mod_ipv6]](?<vendor_transport>[Uu][Dd][Pp])\,(?<transport_id>[^\,]*)\,(?<bytes>[^\,]*)\,(?<src_ip>[^\,]*)\,(?<dest_ip>[^\,]*)\,(?<src_port>[^\,]*)\,(?<dest_port>[^\,]*)\,(?<payload_bytes>\S*)

[opnsense_datalength]
REGEX = datalength=(?<data_length>\d+)

#===========================================
# Search Time Field Extractions:  LIGHTTPD
#===========================================
[opnsense_lighttpd_extract]
REGEX  = lighttpd\[\d+\]\:\s+(\S+)\s+(\S+)\s+\-\s+\[([^\]]+)\]\s+\"(\S+)\s+(.+?)(\?\S+)*\s+([^\"]+)\"\s+(\d+)\s+(\d+)\s+\"([^\"]+)\"\s+\"([^\"]+)
FORMAT = src_ip::$1 dest_ip::$2 vendor_timestamp::$3 http_method::$4 uri_path::$5 uri_query::$6 protocol_version::$7 status::$8 tbd::$9 url::$10 http_user_agent::$11

#===========================================
# Search Time Field Extractions:  OPENVPN
#===========================================
[opnsense_openvpn_auth]
REGEX  = user\s+\'([^\']+)'\s+\S+\s+\S+\s+\'([^\']+)
FORMAT = user::$1 auth_method::$2

[opnsense_openvpn_destip]
REGEX = ifconfig\s+(?<dest_ip>\S+)

[opnsense_openvpn_extract]
REGEX = openvpn(?:_(?<vpn_instance>[^\[\:]+))?(?:\[(?<pid>[^\]]+)\])?:\s+(?<user>[^\/]+)\/(?<src_ip>[^:]+):(?<src_port>\d+)

[opnsense_openvpn_src]
REGEX  = openvpn(?:_(?<vpn_instance>[^\[\:]+))?(?:\[(?<pid>[^\]]+)\])?:*\s(?<src_ip>\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3})\:(?<src_port>\d+)\s

#===========================================
# Search Time Field Extractions:  SURICATA
#===========================================
[opnsense_suricata_category]
REGEX  = Classification\:\s+([^\]]+)
FORMAT = category::"$1"

[opnsense_suricata_dest_ip]
REGEX  = \-\>\s+([^\:]+)
FORMAT = dest_ip::$1

[opnsense_suricata_dest_port]
REGEX  = \-\>\s+[^\:]+\:(\S+)
FORMAT = dest_port::$1

[opnsense_suricata_pid]
REGEX  = suricata\[([^\]]+)
FORMAT = pid::$1

[opnsense_suricata_severity_id]
REGEX  = Priority\:\s+([^\]]+)
FORMAT = severity_id::$1

[opnsense_suricata_signature_id_action]
REGEX  = suricata\[[^\]]+\]\:\s+(?:\[([^\]]+)]\s)*\[\d+:([^\:]+)[^\]]+\]\s+([^\]]+)\s+\[
FORMAT = vendor_action::$1 signature_id::$2 signature::"$3"

[opnsense_suricata_src_ip]
REGEX  = \{[^\}]+\}\s+([^\:]+)
FORMAT = src_ip::$1

[opnsense_suricata_src_port]
REGEX  = \{[^\:]+\:(\S+)
FORMAT = src_port::$1

[opnsense_suricata_transport]
REGEX  = \{([^\}]+)
FORMAT = vendor_transport::$1

#===========================================
# Search Time Field Extractions:  SQUID
#===========================================
[1_opnsense_squid_main]
REGEX  = \:\s+\S+\s+(\d+)\s+(\S+)\s+([^\/]+)\/(\S+)\s+(\S+)\s+(\S+)\s+(\S+)\s+(\S+)\s+([^\/]+)\/(\S+)\s+(\S+)
FORMAT = duration::$1 src_ip::$2 vendor_action::$3 status::$4 bytes_in::$5 bytes_out::0 http_method::$6 url::$7 user::$8 dest_status::$9 dest_ip::$10 http_content_type::$11

[2_opnsense_squid_url]
SOURCE_KEY = url
REGEX = (\d{1,3}(?:\.\d{1,3}){3})
FORMAT = dest_ip_url::$1

#===========================================
# Search Time Field Extractions:  SYSLOG
#===========================================
[opnsense_kv_syslog]
REGEX = (?<_KEY_1>\S+)='(?<_VAL_1>[^']+)

[opnsense_syslog_extractions]
REGEX  = \s([^\s\[]+)(?:\[(\d+)\])?:\s
FORMAT = process::$1 pid::$2

#===========================================
# Search Time Field Extractions:  UNBOUND
#===========================================
[opnsense_unbound_query]
REGEX = info:\s+(\S+)\s+(\S+)\s+(\S+)\s+IN
FORMAT = src::$1 query::$2 record_type::$3

#===========================================
# Advanced Search Time Configs
#===========================================
[opnsense_vendor_tcp_flag]
SOURCE_KEY = vendor_tcp_flags
REGEX      = (\w)
FORMAT     = vendor_tcp_flag::$1
MV_ADD     = true

[opnsense_vendor_options]
SOURCE_KEY = vendor_options
REGEX      = (\w+)
FORMAT     = vendor_option::$1
MV_ADD     = true

#===========================================
# Lookups:  AUDIT
#===========================================
[opnsense_audit_action_lookup]
filename             = opnsense_audit_actions.csv
case_sensitive_match = false
match_type           = WILDCARD(signature), EXACT(action)

#===========================================
# Lookups:  FILTERLOG
#===========================================
[opnsense_filterlog_action_lookup]
filename      = opnsense_filterlog_action.csv
min_matches   = 1
default_match = unknown

[opnsense_filterlog_direction_lookup]
filename      = opnsense_filterlog_direction.csv
min_matches   = 1
default_match = unknown

[opnsense_filterlog_tcp_flags_lookup]
filename      = opnsense_filterlog_tcp_flags.csv
min_matches   = 1
default_match = unknown

[opnsense_transport_lookup]
filename             = opnsense_transport.csv
max_matches          = 1
min_matches          = 1
default_match        = unknown
case_sensitive_match = false

[opnsense_tos_lookup]
filename             = opnsense_filterlog_tos.csv
min_matches          = 1
default_match        = unknown
case_sensitive_match = false

#===========================================
# Lookups:  LIGHTTPD
#===========================================
[opnsense_http_status_lookup]
filename             = opnsense_http_status.csv
min_matches          = 1
default_match        = unknown
case_sensitive_match = false

#===========================================
# Lookups:  SURICATA
#===========================================
[opnsense_suricata_severity_lookup]
filename      = opnsense_suricata_severities.csv
min_matches   = 1
default_match = unknown

#===========================================
# Lookups:  SQUID
#===========================================
[opnsense_squid_action_lookup]
filename      = opnsense_squid_actions.csv
max_matches   = 1
min_matches   = 1
default_match = unknown

[opnsense_squid_status_lookup]
filename = opnsense_squid_status.csv
